var Vr=pc.createScript("vr");Vr.attributes.add("buttonVr",{type:"entity",title:"VR Button"}),Vr.attributes.add("elementUnsupported",{type:"entity",title:"Unsupported Message"}),Vr.attributes.add("elementHttpsRequired",{type:"entity",title:"HTTPS Required Message"}),Vr.attributes.add("cameraEntity",{type:"entity",title:"Camera"}),Vr.prototype.initialize=function(){this.buttonVr.element.on("click",(function(){this.sessionStart()}),this),this.app.keyboard.on("keydown",(function(t){t.key===pc.KEY_ESCAPE&&this.app.xr.active&&this.app.xr.end()}),this),this.checkButton(!1),this.setEvents("on"),this.on("destroy",(function(){this.setEvents("off")}),this)},Vr.prototype.setEvents=function(t){this.app.xr[t]("available:"+pc.XRTYPE_VR,this.onAvailable,this),this.app.xr[t]("start",this.onStart,this),this.app.xr[t]("end",this.onEnd,this)},Vr.prototype.checkButton=function(t){if(this.app.xr.supported)if(this.elementHttpsRequired.enabled=!1,this.elementUnsupported.enabled=!1,t)this.buttonVr.enabled=!1;else{this.buttonVr.enabled=!0;var e=this.app.xr&&!this.app.xr.active&&this.app.xr.isAvailable(pc.XRTYPE_VR);this.buttonVr.element.opacity=e?.2:.1,this.buttonVr.children[0].element.opacity=e?1:.2}else this.buttonVr.enabled=!1,"https:"==window.location.protocol?(this.elementUnsupported.enabled=!0,this.elementHttpsRequired.enabled=!1):(this.elementUnsupported.enabled=!1,this.elementHttpsRequired.enabled=!0)},Vr.prototype.sessionStart=function(){this.app.xr.supported&&(this.app.xr.active||this.app.xr.isAvailable(pc.XRTYPE_VR)&&this.cameraEntity.camera.startXr(pc.XRTYPE_VR,pc.XRSPACE_LOCAL))},Vr.prototype.onAvailable=function(){this.checkButton(!1)},Vr.prototype.onStart=function(){this.checkButton(!0)},Vr.prototype.onEnd=function(){this.checkButton(!1)};var Controllers=pc.createScript("controllers");Controllers.attributes.add("controllerTemplate",{type:"entity",title:"Controller Template"}),Controllers.attributes.add("cameraParent",{type:"entity",title:"Camera Parent"}),Controllers.prototype.initialize=function(){this.app.xr.input.on("add",(function(t){var e=this.controllerTemplate.clone();e.script.controller.setInputSource(t),e.reparent(this.cameraParent),e.enabled=!0}),this)};var Controller=pc.createScript("controller");Controller.prototype.initialize=function(){this.vecA=new pc.Vec3,this.vecB=new pc.Vec3,this.matA=new pc.Mat4,this.quat=new pc.Quat,this.color=new pc.Color(1,1,1),this.modelEntity=this.entity.findByName("model"),this.hoverEntity=null,this.targetPointerSize=2,this.targetTeleportable=!1,this.pointer=this.entity.findByName("pointer");var t=this.pointer.element,e=t.material.clone();t.material=e,e.depthTest=!1,t.material=e;var i=t.color.clone();t.color=new pc.Color(i.r,i.g+.01,i.b),t.color=i;var o=t.opacity;t.opacity=0,t.opacity=o,e.update(),this.hoverPoint=new pc.Vec3,this.pointerDistance=3,this.on("destroy",(function(){t.material=null,e.destroy()}),this)},Controller.prototype.setInputSource=function(t){this.inputSource=t,this.inputSource.once("remove",this.onRemove,this),this.on("hover",this.onHover,this),this.on("blur",this.onBlur,this),this.inputSource.on("select",this.onSelect,this)},Controller.prototype.onRemove=function(){this.entity.destroy()},Controller.prototype.onSelect=function(){if(this.app.fire("object:pick",this),this.hoverEntity)if(this.targetTeleportable)this.app.fire("controller:teleport",this.hoverPoint);else if(this.hoverEntity.tags.has("interactive")){var t=this.hoverEntity.render.meshInstances[0];t.pickedColor||(t.pickedColor=new pc.Color),t.pickedColor.set(Math.random(),Math.random(),Math.random()),t.setParameter("material_diffuse",t.pickedColor.data3)}},Controller.prototype.onHover=function(t,e){this.hoverEntity=t,this.hoverPoint.copy(e),this.targetPointerSize=16,this.targetTeleportable=this.hoverEntity.tags.has("teleportable")},Controller.prototype.onBlur=function(){this.hoverEntity=null,this.targetPointerSize=4,this.targetTeleportable=!1},Controller.prototype.update=function(t){if(this.app.fire("object:pick",this),this.inputSource.grip&&(this.modelEntity.enabled=!0,this.entity.setPosition(this.inputSource.getPosition()),this.entity.setRotation(this.inputSource.getRotation()),this.vecA.copy(this.inputSource.getOrigin()),this.vecB.copy(this.inputSource.getDirection()),this.vecB.scale(1e3).add(this.vecA),this.inputSource.selecting?this.color.set(0,1,0):this.color.set(1,1,1),this.app.renderLine(this.vecA,this.vecB,this.color)),this.hoverEntity){var e=this.vecA.copy(this.hoverPoint).sub(this.inputSource.getOrigin()).length();this.pointerDistance+=.3*(e-this.pointerDistance)}this.vecA.copy(this.inputSource.getDirection()).scale(this.pointerDistance).add(this.inputSource.getOrigin()),this.pointer.setPosition(this.vecA);var i=this.targetPointerSize*(this.targetTeleportable?8:1);this.pointer.element.width!==i&&(this.pointer.element.width+=.3*(i-this.pointer.element.width),Math.abs(this.pointer.element.width-i)<=1&&(this.pointer.element.width=i),this.pointer.element.height=this.pointer.element.width),this.targetTeleportable?this.pointer.setEulerAngles(-90,0,0):this.app.xr.camera&&(this.pointer.lookAt(this.app.xr.camera.getPosition(),pc.Vec3.DOWN),this.pointer.rotateLocal(0,180,0));var o=this.inputSource.gamepad;o&&(this.inputSource.handedness===pc.XRHAND_LEFT&&(o.axes[3]||o.axes[2])?this.app.fire("controller:move",o.axes[2],o.axes[3],t):this.inputSource.handedness===pc.XRHAND_RIGHT&&o.axes[2]&&this.app.fire("controller:rotate",-o.axes[2],t))};var ObjectPicker=pc.createScript("objectPicker");ObjectPicker.prototype.initialize=function(){this.entities=this.app.root.findByTag("pickable"),this.ray=new pc.Ray,this.vec3A=new pc.Vec3,this.vec3B=new pc.Vec3,this.app.on("object:pick",this.pick,this)},ObjectPicker.prototype.pick=function(i){var t=null,e=1/0;this.ray.set(i.inputSource.getOrigin(),i.inputSource.getDirection());for(var c=0;c<this.entities.length;c++){if(this.entities[c].render)if(this.entities[c].render.meshInstances[0].aabb.intersectsRay(this.ray,this.vec3A)){var r=this.vec3A.distance(this.ray.origin);r<e&&(e=r,t=this.entities[c],this.vec3B.copy(this.vec3A))}}t?i.fire("hover",t,this.vec3B):i.hoverEntity&&i.fire("blur")};var CameraController=pc.createScript("camera-controller");CameraController.attributes.add("height",{type:"number",default:1.6,placeholder:"m",title:"Height from Floor"}),CameraController.attributes.add("movementSpeed",{type:"number",default:1.5,placeholder:"m/s",title:"Movement Speed"}),CameraController.attributes.add("rotateSpeed",{type:"number",default:45,placeholder:"Â°",title:"Rotation Speed"}),CameraController.attributes.add("rotateThreshold",{type:"number",default:.5,min:0,max:1,title:"Rotation thumbstick threshold"}),CameraController.attributes.add("rotateResetThreshold",{type:"number",default:.25,min:0,max:1,title:"Rotation thumbstick reset threshold"}),CameraController.attributes.add("camera",{type:"entity",title:"Camera Entity"}),CameraController.prototype.initialize=function(){this.vec2A=new pc.Vec2,this.vec2B=new pc.Vec2,this.vec3A=new pc.Vec3,this.lastRotate=0,this.lastRotateValue=0,this.app.on("controller:teleport",this.onTeleport,this),this.app.on("controller:move",this.onMove,this),this.app.on("controller:rotate",this.onRotate,this),this.on("destroy",(function(){this.app.off("controller:teleport",this.onTeleport,this),this.app.off("controller:move",this.onMove,this),this.app.off("controller:rotate",this.onRotate,this)}),this)},CameraController.prototype.onTeleport=function(t){this.app.xr.type!==pc.XRTYPE_AR&&(this.vec3A.copy(this.camera.getLocalPosition()).scale(-1),this.entity.setPosition(t),this.entity.translate(0,this.height,0),this.entity.translateLocal(this.vec3A))},CameraController.prototype.onMove=function(t,e,a){if(this.vec2A.set(t,e),this.vec2A.length()){this.vec2A.normalize(),this.vec2B.x=this.camera.forward.x,this.vec2B.y=this.camera.forward.z,this.vec2B.normalize();var o=Math.atan2(this.vec2B.x,this.vec2B.y)-Math.PI/2,i=this.vec2A.x*Math.sin(o)-this.vec2A.y*Math.cos(o);this.vec2A.y=this.vec2A.y*Math.sin(o)+this.vec2A.x*Math.cos(o),this.vec2A.x=i,this.vec2A.scale(this.movementSpeed),this.entity.translate(this.vec2A.x*a,0,this.vec2A.y*a)}},CameraController.prototype.onRotate=function(t,e){if(!(Date.now()-this.lastRotate<200)){if(0!==this.lastRotateValue)if(this.lastRotateValue>0){if(!(t<this.rotateResetThreshold))return;this.lastRotateValue=0}else{if(!(t>-this.rotateResetThreshold))return;this.lastRotateValue=0}Math.abs(t)>this.rotateThreshold&&(this.lastRotateValue=Math.sign(t),this.vec3A.copy(this.camera.getLocalPosition()),this.entity.translateLocal(this.vec3A),this.entity.rotateLocal(0,Math.sign(t)*this.rotateSpeed,0),this.entity.translateLocal(this.vec3A.scale(-1)))}};